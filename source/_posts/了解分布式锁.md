---
title: 了解分布式锁
date: 2025-06-26 17:01:44
tags:
---


### 什么是分布式锁

在前面 {% post_link '初探并发安全' %} 中，我们提到锁在并发安全中的作用，但是jvm提供的锁，只能约束单机内的并发线程。而单机无法满足高并发的业务需求，服务器集群下jvm的锁就失效了，这时候就需要考虑分布式锁

### 分布式锁的应用场景

- redis的缓存击穿问题下，如果所有线程都尝试去重建缓存，对数据库的压力过大，需要让一个线程去重建缓存，可以使用redis实现的分布式锁。此处共享变量是数据库中的某一条数据，锁则是redis中间件的关于某一条数据的key。
- 超卖问题的一人一单问题（没有redis缓存版本），访问库存、检查订单、扣减库存、写入订单，对于同一个用户的并发访问，这四步需要连贯完成，可以使用redis实现分布式锁。此处共享变量是数据库中的多条数据，锁则是redis中间件的关于某一个用户的key。

分布式锁的应用对象主要是数据库，而在前面 {% post_link '初探并发安全' %} 中，锁约束的一般是对象共享字段；分布式锁依赖一个唯一第三方组件来实现，而后者则依赖jvm单机。

### 怎么实现分布式锁

分布式锁这么常用，自然有相关的实现，比如redission，但我也了解到分布式锁的几种简单实现
- 基于redis的set nx ex命令。redis本身的单线程属性，再加上lua脚本实现redis多条命令的原子性，可以保证互斥，所以可以使用redis来实现分布式锁。比如set nx，会创建不存在的key，创建成功表示获得锁，创建失败表示没获得锁，删除key就是释放锁；要确保锁能被释放，这就需要ex设置过期时间，但其实还是存在一些问题，时长怎么确定？然后还有一个就是误删问题，这就需要在释放锁时判断value，value应该记录获得锁的线程的信息；还有可重入，阻塞等待等特性需要进一步考虑
- 基于mysql数据库。可以利用数据库本身的锁机制，以及主键的唯一性可以保证互斥，比如对一张表写某个主键，写成功表示获得锁，删除表示释放锁。